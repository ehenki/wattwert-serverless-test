steps:
  # ==========================================================
  # 1. SHARED BACKEND (wattwert-backend)
  # ==========================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend'
    args: ['build', '-t', '$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/backend:latest', '.']
    dir: 'backend'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend'
    args: ['push', '$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/backend:latest']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-backend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'wattwert-backend'
      - '--image=$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/backend:latest'
      - '--region=${_REGION}'
      - '--memory=2Gi' # Make sure we have enough memory to build with heavy libraries
      - '--port=8000'
      - '--ingress=internal'  
      - '--no-allow-unauthenticated'
      - '--network=default'
      - '--subnet=default'
      - '--set-secrets=SUPABASE_URL=SUPABASE_URL:latest,SUPABASE_ANON_KEY=SUPABASE_ANON_KEY:latest,HF_TOKEN=HF_TOKEN:latest'

  # ==========================================================
  # 2. FEATURE BACKEND (wattwert-backend-geruest)
  # ==========================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-geruest'
    args: ['build', '-t', '$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/backend-geruest:latest', '.']
    dir: 'backend_geruest'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-geruest'
    args: ['push', '$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/backend-geruest:latest']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-geruest'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'wattwert-backend-geruest'
      - '--image=$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/backend-geruest:latest'
      - '--region=${_REGION}'
      - '--port=8003'
      - '--memory=2Gi' # Make sure we have enough memory to build with heavy libraries
      - '--allow-unauthenticated'
      - '--network=default'
      - '--set-env-vars=BACKEND_LOD2_URL=${_BACKEND_LOD2_URL},ALLOWED_ORIGINS=${_ALLOWED_ORIGINS}'
      - '--set-secrets=SUPABASE_URL=SUPABASE_URL:latest,SUPABASE_ANON_KEY=SUPABASE_ANON_KEY:latest,HF_TOKEN=HF_TOKEN:latest'

  # ==========================================================
  # 3. FRONTEND (wattwert-frontend)
  # ==========================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker build \
          -t $_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/frontend:latest \
          --build-arg NEXT_PUBLIC_API_URL=${_NEXT_PUBLIC_API_URL} \
          --build-arg NEXT_PUBLIC_MAPBOX_TOKEN=$$MAPBOX_TOKEN \
          --build-arg NEXT_PUBLIC_SUPABASE_URL=$$SUPABASE_URL \
          --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY=$$SUPABASE_ANON_KEY \
          --build-arg NEXT_RESEND_API_KEY=$$RESEND_KEY \
          .
    secretEnv: ['MAPBOX_TOKEN', 'SUPABASE_URL', 'SUPABASE_ANON_KEY', 'RESEND_KEY']
    dir: 'frontend'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend'
    args: ['push', '$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/frontend:latest']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-frontend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'wattwert-frontend'
      - '--image=$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/frontend:latest'
      - '--region=${_REGION}'
      - '--allow-unauthenticated'

# ==========================================================
# CONFIGURATION & SECRETS
# ==========================================================
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/SUPABASE_URL/versions/latest
      env: 'SUPABASE_URL'
    - versionName: projects/$PROJECT_ID/secrets/SUPABASE_ANON_KEY/versions/latest
      env: 'SUPABASE_ANON_KEY'
    - versionName: projects/$PROJECT_ID/secrets/MAPBOX_TOKEN/versions/latest
      env: 'MAPBOX_TOKEN'
    - versionName: projects/$PROJECT_ID/secrets/RESEND_KEY/versions/latest # Fixed: Matches your secret name
      env: 'RESEND_KEY'

substitutions:
  _REGION: europe-west1
  _NEXT_PUBLIC_API_URL: "https://wattwert-backend-geruest-1049303488847.europe-west1.run.app"
  _BACKEND_LOD2_URL: "https://wattwert-backend-1049303488847.europe-west1.run.app"
  # This list of origins is passed to the backend-geruest to ALLOW requests from the frontend
  # Note: The frontend URL is what we expect here. It matches the frontend service URL.
  _ALLOWED_ORIGINS: "http://localhost:3000\,https://wattwert-frontend-1049303488847.europe-west1.run.app"

options:
  logging: CLOUD_LOGGING_ONLY

# Keep this for redundancy/documentation, though explicit pushes are now in steps
images:
  - '$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/backend:latest'
  - '$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/backend-geruest:latest'
  - '$_REGION-docker.pkg.dev/$PROJECT_ID/wattwert-serverless-test-1/frontend:latest'